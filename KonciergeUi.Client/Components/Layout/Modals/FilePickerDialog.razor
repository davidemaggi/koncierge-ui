@using KonciergeUI.Translations.Services
@using Microsoft.Maui.Storage
@using MudBlazor
@using System.IO
@using System.Linq
@inject ILocalizationService L
@inject ISnackbar Snackbar

<MudDialog ContentClass="border-none pa-0" Style="height: 320px; width: 600px;">
    <TitleContent>
        <MudText Typo="Typo.h6">@L.Resources["add_kubeconfig"]</MudText>
    </TitleContent>

    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.body1">
                @L.Resources["add_kubeconfig_description"]
            </MudText>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Folder"
                       OnClick="PickFilesAsync">
                @(_multi ? L.Resources["select_files"] : L.Resources["select_file"])
            </MudButton>

            @if (_filePaths.Count == 0)
            {
                <MudText Color="Color.Secondary">@L.Resources["no_files_selected"]</MudText>
            }
            else
            {
                <MudList T="string" Dense="true">
                    @foreach (var path in _filePaths)
                    {
                        <MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.InsertDriveFile">@Path.GetFileName(path)</MudListItem>
                        </MudListItem>
                    }
                </MudList>
            }
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!_filePaths.Any())"
                   OnClick="ConfirmSelection">
            @L.Resources["confirm"]
        </MudButton>
        <MudButton Color="Color.Error"
                   Variant="Variant.Text"
                   Disabled="@(!_filePaths.Any())"
                   OnClick="ClearSelection">
            @L.Resources["clear"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
#nullable enable
    private readonly List<string> _filePaths = new();

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public int _amount { get; set; } = 1;
    [Parameter] public bool _multi { get; set; }

    private async Task PickFilesAsync()
    {
        try
        {
            if (_multi)
            {
                var picked = await FilePicker.Default.PickMultipleAsync(new PickOptions
                {
                    PickerTitle = L.Resources["add_kubeconfig"],
                });

                if (picked is null)
                {
                    return;
                }

                _filePaths.Clear();
                foreach (var file in picked.Take(_amount))
                {
                    if (!string.IsNullOrWhiteSpace(file?.FullPath))
                    {
                        _filePaths.Add(file.FullPath);
                    }
                }
            }
            else
            {
                var single = await FilePicker.Default.PickAsync(new PickOptions
                {
                    PickerTitle = L.Resources["add_kubeconfig"],
                });

                if (single?.FullPath is string path && !string.IsNullOrWhiteSpace(path))
                {
                    _filePaths.Clear();
                    _filePaths.Add(path);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L.Errors["file_picker_failed"]}: {ex.Message}", Severity.Error);
        }
    }

    private void ConfirmSelection()
    {
        if (!_filePaths.Any())
        {
            Snackbar.Add(L.Errors["select_file_first"], Severity.Warning);
            return;
        }

        MudDialog?.Close(DialogResult.Ok(new List<string>(_filePaths)));
    }

    private void ClearSelection()
    {
        if (_filePaths.Any())
        {
            _filePaths.Clear();
        }
    }
}
