@using KonciergeUi.Client.Components.Layout.Summaries
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Models.Forwarding
@using KonciergeUI.Models.Kube
@using KonciergeUI.Models.Security
@using static KonciergeUI.Models.Forwarding.Enums
@using System.Linq
@using KonciergeUI.Translations.Services
@inject ISnackbar Snackbar
@inject IKubeRepository KubeRepo
@inject ILocalizationService L
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.ForwardToInbox" Class="mr-3 mb-n1"/>
            @L.Forwards["create_forward_title"]
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack>
            <ResourceSummary _kind="_kind" _namespace="@_namespace"  _resourceName="@_resourceName"/>
        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <MudStack>
                <MudStack Row>
                    <MudNumericField Disabled="true" @bind-Value="_newForwardRequest.TargetPort" Label="@L.Forwards["remote_port"]" Variant="Variant.Text" Min="0" Max="65535"/>
                    <MudNumericField @bind-Value="_newForwardRequest.LocalPort" Label="@L.Forwards["local_port"]" Variant="Variant.Text" Min="0" Max="65535"/>
                </MudStack>
                <MudSelect T="ForwardProtocol"
                           Label="@L.Forwards["protocol"]"
                           Variant="Variant.Outlined"
                           @bind-Value="_newForwardRequest.Protocol"
                           Disabled="true"
                           >
                    <MudSelectItem T="Enums.ForwardProtocol" Value="Enums.ForwardProtocol.Http">HTTP</MudSelectItem>
                    <MudSelectItem T="Enums.ForwardProtocol" Value="Enums.ForwardProtocol.Https">HTTPS</MudSelectItem>
                    <MudSelectItem  T="Enums.ForwardProtocol"Value="Enums.ForwardProtocol.Tcp">TCP</MudSelectItem>
                    <MudSelectItem  T="Enums.ForwardProtocol" Value="Enums.ForwardProtocol.Grpc">GRPC</MudSelectItem>
                </MudSelect>
            </MudStack>
        </MudForm>
            <MudStack StretchItems="StretchItems.Start" Row>
                <MudText>@L.Forwards["linked_secrets"]</MudText>
                <MudSpacer/>
                <MudChip T="string" OnClick="ShowAddLinked">@L.Forwards["link_a_secret"]</MudChip>
            </MudStack>
            @if (_configMapsSel.Count != 0 || _secretsSel.Count != 0){
            <MudCard Outlined="true">
                    <MudList T="SecretReference" @bind-SelectedValues="SelectedLinks" SelectionMode="SelectionMode.MultiSelection" ReadOnly="false" CheckBoxColor="Color.Tertiary">
                        <MudListSubheader>
                            @L.Forwards["select_item_link"]:
                        </MudListSubheader>

                        @if (_configMapsSel.Count>0){
                        <MudListItem Text="@L.Global["k8s_configmaps"]">
                            <NestedList>
                                @foreach(var cm in _configMapsSel)
                                {
                                    <MudListItem Text="@cm.Key">
                                        <NestedList>
                                            
                                                    @foreach(var d in cm.Value)
                                                    {

                                                        <MudListItem T="SecretReference" Value="d" Text="@($"{d.Key}")" />

                                                    }

                                            
                                        </NestedList>
                                    </MudListItem>

                                }
                            </NestedList>
                        </MudListItem>
                        }
                        @if (_secretsSel.Count > 0)
                        {
                            <MudListItem Text="@L.Global["k8s_secrets"]">
                                <NestedList>
                                    @foreach(var s in _secretsSel)
                                    {
                                        <MudListItem Text="@s.Key">
                                            <NestedList>
                                            
                                                @foreach(var d in s.Value)
                                                {

                                                    <MudListItem T="SecretReference" Value="d" Text="@($"{d.Key}")" />

                                                }

                                            
                                            </NestedList>
                                        </MudListItem>

                                    }
                                </NestedList>
                            </MudListItem>
                        }
                    </MudList>
             </MudCard>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L.Global["crud_cancel"]</MudButton>
        <MudButton Color="Color.Success" OnClick="CreateForward">@L.Global["crud_create"]</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public ContainerPort? _containerPort { get; set; } 

    [Parameter]
    public Enums.ResourceType _kind { get; set; }
    [Parameter]
    public string _namespace { get; set; } 
    [Parameter]
    public string _resourceName { get; set; } 
    [Parameter]
    public ServicePort? _servicePort { get; set; } 

    [Parameter]
    public ClusterConnectionInfo _cluster { get; set; }

    [Parameter]
    public PortForwardDefinition? _existingForward { get; set; }

    private void Cancel() => MudDialog.Cancel();

    private PortForwardDefinition _newForwardRequest;


    bool success;
    string[] errors = { };
    MudTextField<string> pwField1;
    MudForm form;
    private List<ConfigMapInfo> _configMaps { get; set; } = new List<ConfigMapInfo>();
    private List<SecretInfo> _secrets { get; set; } = new List<SecretInfo>();

    private Dictionary<string,List<SecretReference>> _configMapsSel { get; set; } = new ();
    private Dictionary<string,List<SecretReference>> _secretsSel { get; set; } = new();
    public IReadOnlyCollection<SecretReference> SelectedLinks = new List<SecretReference>();




    protected override async Task OnInitializedAsync()
    {
        if (_existingForward is not null)
        {
            _newForwardRequest = CloneForward(_existingForward);
            SelectedLinks = _newForwardRequest.LinkedSecrets.ToList();
            await base.OnInitializedAsync();
            return;
        }

        _newForwardRequest = new PortForwardDefinition
        {
            ResourceName = _resourceName,
            Namespace = _namespace,
            ResourceType = _kind,
            TargetPort = _containerPort is not null
                ? _containerPort.Port
                : _servicePort.Port,
            LocalPort = 0,
            LinkedSecrets = new List<SecretReference>(),
            Name = $"{_namespace}.{_resourceName}:xxx",
            Id = Guid.CreateVersion7()
        };

        await base.OnInitializedAsync();
    }

    private async Task ShowAddLinked()
    {
        _configMaps = await KubeRepo.ListConfigMapsAsync(_cluster, _namespace);
        _secrets = await KubeRepo.ListSecretsAsync(_cluster, _namespace);

        _configMapsSel = new();
        _secretsSel = new();


        foreach (var cm in _configMaps)
        {
            var tmp=new List<SecretReference>();
            foreach (var d in cm.Data)
            {


                tmp.Add(new SecretReference { Key=d.Key, SourceType= SecretSourceType.ConfigMap, ResourceName= cm.Name, Namespace=cm.NameSpace });

            }
            _configMapsSel.Add(cm.Name, tmp);

        }

        foreach (var s in _secrets)
        {
        var tmp=new List<SecretReference>();

            foreach (var d in s.Data)
            {


                tmp.Add(new SecretReference { Key = d.Key, SourceType = SecretSourceType.Secret, ResourceName = s.Name, Namespace = s.NameSpace });

            }
        _secretsSel.Add(s.Name, tmp);


        }

    }



    private async Task CreateForward()
    {
        _newForwardRequest.LinkedSecrets = SelectedLinks.ToList();
        MudDialog.Close(DialogResult.Ok(_newForwardRequest));
    }

    private static PortForwardDefinition CloneForward(PortForwardDefinition forward)
    {
        return forward with
        {
            LinkedSecrets = forward.LinkedSecrets is null
                ? new List<SecretReference>()
                : new List<SecretReference>(forward.LinkedSecrets)
        };
    }

}