@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Models.Kube
@using KonciergeUi.Client.State
@using KonciergeUi.Client.Extensions
@inject IClusterDiscoveryService ClusterService
@inject UiState _ui

<MudStack StretchItems="StretchItems.Start" Row>
    @if (_selectionEnabled || SelectedCluster is null) {
    <MudSelect T="ClusterConnectionInfo?"
           Label="@Label"
           Value="SelectedCluster"
           ValueChanged="ClusterSelected"
           Variant="@Variant"
           FullWidth="true"
           Disabled="@(IsLoading || Disabled)">
    
    @if (IsLoading)
    {
        <MudSelectItem T="ClusterConnectionInfo?" Value="@null" Disabled="true">
            Loading clusters...
        </MudSelectItem>
    }
    else if (!_groupedClusters.Any())
    {
        <MudSelectItem T="ClusterConnectionInfo?" Value="@null" Disabled="true">
            No clusters found
        </MudSelectItem>
    }
    else
    {
        <MudSelectItem T="ClusterConnectionInfo?" Value="@null">
            Select a cluster...
        </MudSelectItem>

        @foreach (var group in _groupedClusters)
        {
            <!-- Group header as disabled item -->
            <MudSelectItem T="ClusterConnectionInfo?" Value="@null" Disabled="true">
                <MudStack AlignItems="AlignItems.Start" Row>
                    <MudIcon Color="Color.Primary" Icon="@KonciergeIcons.Outlined.Resources" />
                    <MudStack>
                    <MudText Style="font-weight:bold" Typo="Typo.subtitle2" >
                    @GetGroupLabel(group.Key) (@group.Value.Count Contexts)
                </MudText>
                 <MudText Style="font-style:italic" Typo="Typo.body2">
                     @($"{group.Value.First().KubeconfigPath}")
                </MudText>
                </MudStack>
                </MudStack>
            </MudSelectItem>

            <!-- Group items -->
            @foreach (var cluster in group.Value)
            {
                <MudSelectItem T="ClusterConnectionInfo?" Value="@cluster">
                    <MudStack Row Spacing="1" AlignItems="AlignItems.Start" Class="pl-4">
                        <MudIcon Icon="@KonciergeIcons.Outlined.Templates" 
                                 Size="Size.Small" 
                                 Color="@(cluster.IsCurrentContext ? Color.Success : Color.Default)" />
                        <MudStack>
                           <MudText>@cluster.Name</MudText>
                           <MudText>@($"Default Namespace: {cluster.DefaultNamespace}")</MudText>

                       
                        </MudStack>
                    </MudStack>
                </MudSelectItem>
            }
        }
    }
        </MudSelect>
    }
    else
    {
        <MudButton Color="Color.Primary" Style="justify-content: flex-start" OnClick="ToggleEditing" Variant="Variant.Outlined">

         <MudStack  AlignItems="AlignItems.Center" Row>
                    <MudIcon Color="Color.Primary" Icon="@KonciergeIcons.Outlined.Resources" />
                    <MudStack AlignItems="AlignItems.Start">
                    <MudText Style="font-weight:bold" Typo="Typo.subtitle2" >
                    @($"{_ui.SelectedCluster.Name} -> {_ui.SelectedCluster.ContextName}")
                </MudText>
                 <MudText Style="font-style:italic" Typo="Typo.body2">
                     @($"{GetGroupLabel(_ui.SelectedCluster.KubeconfigPath)} Default Namespace: {_ui.SelectedCluster.DefaultNamespace}")
                </MudText>
                </MudStack>
                </MudStack>
                </MudButton>
   }

    

</MudStack>
@code {
    private Dictionary<string, List<ClusterConnectionInfo>> _groupedClusters = new();
    private bool IsLoading = true;
    private bool _selectionEnabled = false;

    [Parameter]
    public ClusterConnectionInfo? SelectedCluster { get; set; }

    [Parameter]
    public EventCallback<ClusterConnectionInfo?> _onClusterSelection { get; set; }

    [Parameter]
    public string Label { get; set; } = "Select cluster";

    [Parameter]
    public Variant Variant { get; set; } = Variant.Outlined;

    [Parameter]
    public bool Disabled { get; set; }


    protected override async Task OnInitializedAsync()
    {
        await LoadClusters();


        // Restore last selected cluster
        var lastClusterId = await _ui.GetLastSelectedClusterIdAsync();
        if (!string.IsNullOrEmpty(lastClusterId))
        {
            var cluster = await ClusterService.GetClusterByIdAsync(lastClusterId);
            if (cluster != null)
            {
                _ui.SelectedCluster = cluster;
                SelectedCluster = cluster;
                await _onClusterSelection.InvokeAsync(SelectedCluster);
            }
            else
            {
                _selectionEnabled = true;  

            }
        }
        else
        {
            _selectionEnabled = true;  
        }
    }
    


    private async Task LoadClusters()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var data = await ClusterService.DiscoverClustersAsync();

            // Group by kubeconfig path
            _groupedClusters = data
                .GroupBy(c => c.KubeconfigPath)
                .OrderByDescending(g => g.Any(c => c.IsDefaultKubeconfig)) // Default first
                .ThenBy(g => g.Key)
                .ToDictionary(
                    g => g.Key, 
                    g => g.OrderByDescending(c => c.IsCurrentContext)
                          .ThenBy(c => c.Name)
                          .ToList()
                );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load clusters: {ex.Message}");
            _groupedClusters = new();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private string GetGroupLabel(string kubeconfigPath)
    {
        if (kubeconfigPath.Contains("~/.kube/config") || kubeconfigPath.Contains("\\.kube\\config") )
            return "Default kubeconfig (~/.kube/config)";

        return kubeconfigPath.ToFileNameIfPath();
    }

    public async Task RefreshAsync()
    {
        await LoadClusters();
    }

    public async Task ClusterSelected(ClusterConnectionInfo? sel)
    {
        if (sel is not null) {
            _selectionEnabled = false;
        }

        await _onClusterSelection.InvokeAsync(sel);
    }


    public void ToggleEditing()

    {
        _selectionEnabled = !_selectionEnabled;  
    }


}
