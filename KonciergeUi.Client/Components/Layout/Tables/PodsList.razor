@using KonciergeUi.Client.Components.Layout.Modals
@using KonciergeUi.Client.Shared
@using KonciergeUI.Models.Kube
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Models.Forwarding
@using KonciergeUi.Client.State
@using KonciergeUI.Translations.Services
@using static KonciergeUI.Models.Forwarding.Enums
@using System

@inject IKubeRepository KubeRepo
@inject IDialogService DialogService
@inject UiState _ui
@inject ILocalizationService L

<MudPaper Elevation="2" Class="pa-4">
    <MudTable Items="@_filteredPods" 
              Hover="true" 
              Dense="true" 
              Loading="@_isLoading"
              LoadingProgressColor="Color.Primary"
              FixedHeader="true"
              >
        
        <ToolBarContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@KonciergeIcons.Outlined.Pod" Class="mr-2" />
                @L.Resources["tab_pods"] (@_pods.Count)
            </MudText>
            <MudSpacer />
            
            <!-- Namespace filter -->
            <MudSelect T="string"
                       MultiSelection="true"
                       Clearable="true"
                       SelectedValues="@_ui.SelectedNamespaces"
                       SelectedValuesChanged="@(values => OnNamespacesChanged(values))"
                       Label="@L.Resources["pod_namespace"]" 
                       Variant="Variant.Outlined" 
                       Dense="true"
                       Class="mr-2"
                       Style="min-width: 200px;"
                       MultiSelectionTextFunc="@(new Func<List<string>, string>(GetNamespaceSelectionText))">
                @foreach (var ns in _namespaces)
                {
                    <MudSelectItem T="string" Value="@ns">@ns</MudSelectItem>
                }
            </MudSelect>

            <!-- Status filter -->
            <MudSelect T="string"
                       MultiSelection="true"
                       Clearable="true"
                       SelectedValues="@_ui.SelectedStatuses"
                       SelectedValuesChanged="@(values => OnStatusesChanged(values))"
                       Label="@L.Resources["pod_status"]" 
                       Variant="Variant.Outlined" 
                       Dense="true"
                       Class="mr-2"
                       Style="min-width: 200px;"
                       MultiSelectionTextFunc="@(new Func<List<string>, string>(GetStatusSelectionText))">
                @foreach (var status in Enum.GetValues<PodStatus>())
                {
                    <MudSelectItem T="string" Value="@status.ToString()">@status</MudSelectItem>
                }
            </MudSelect>

            <!-- Search -->
            <MudTextField T="string" Value="@_ui.SearchString"
                          ValueChanged="@(value => OnSearchChanged(value))"
                          Placeholder="@L.Resources["pod_search"]"
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" 
                          IconSize="Size.Medium"
                          Variant="Variant.Outlined"
                          Dense="true"
                          Immediate="true"
                          Class="mr-2"
                          Style="min-width: 200px;" />

            <!-- Refresh button -->
            <MudTooltip Text="@L.Resources["pod_refresh"]">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                               Color="Color.Primary" 
                               OnClick="RefreshAsync"
                               Disabled="@_isLoading" />
            </MudTooltip>
        </ToolBarContent>

        <HeaderContent>
            <MudTh>@L.Resources["pod_name"]</MudTh>
            <MudTh>@L.Resources["pod_namespace"]</MudTh>
            <MudTh>@L.Resources["pod_status"]</MudTh>
            <MudTh>@L.Resources["pod_ports"]</MudTh>
            <MudTh Style="text-align: right;">@L.Resources["pod_actions"]</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="@L.Resources["pod_name"]">
                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@KonciergeIcons.Outlined.Pod" Size="Size.Small" Color="Color.Primary" />
                    <MudText Typo="Typo.body2" Style="font-family: monospace;">@context.Name</MudText>
                </MudStack>
            </MudTd>
            
            <MudTd DataLabel="@L.Resources["pod_namespace"]">
                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                    @context.Namespace
                </MudChip>
            </MudTd>
            
            <MudTd DataLabel="@L.Resources["pod_status"]">
                <MudChip T="string"  Size="Size.Small"
                         Color="@GetStatusColor(context.Status)" 
                         Icon="@GetStatusIcon(context.Status)"
                         Variant="Variant.Filled">
                    @context.Status
                </MudChip>
            </MudTd>

           
            
            <MudTd DataLabel="@L.Resources["pod_ports"]">
                @if (context.Ports.Any())
                {
                    <MudStack Row="true" Spacing="0">
                        @foreach (var port in context.Ports.Take(3))
                        {
                            <MudTooltip Text="@($"{port.ContainerName}: {port.Protocol}")">
                                <MudChip T="string" Size="Size.Small" 
                                         Variant="Variant.Text" 
                                         Color="Color.Info"
                                         Style="margin-right: 4px;">
                                    @port.Name:@port.Port
                                </MudChip>
                            </MudTooltip>
                        }
                        @if (context.Ports.Count > 3)
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Text">
                                +@(context.Ports.Count - 3)
                            </MudChip>
                        }
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="@L.Resources["pod_actions"]">
                @if (context.Ports.Any())
                {
                    <MudStack Row="true" Spacing="0">
                        @foreach (var port in context.Ports)
                        {
                            <MudTooltip Text="@($"{port.ContainerName}: {port.Protocol}")">
                                <MudChip T="string" Size="Size.Small"
                                         Variant="Variant.Filled"
                                         Color="Color.Info"
                                         Disabled="@IsForwardDisabled(port, context)"
                                         OnClick="() => OpenForwardCreate(port, context)"
                                         Style="margin-right: 4px;">
                                    Forward :@port.Port
                                </MudChip>
                            </MudTooltip>
                        }
                       
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                }
            </MudTd>
            
        </RowTemplate>

        <NoRecordsContent>
            <MudAlert Severity="Severity.Info" Class="my-4">
                @if (_isLoading)
                {
                    <MudText>@L.Resources["pod_loading"]</MudText>
                }
                else if (!string.IsNullOrEmpty(_ui.SearchString) || _ui.SelectedNamespaces.Any() || _ui.SelectedStatuses.Any())
                {
                    <MudText>@L.Resources["pod_notfound_search"]</MudText>
                }
                else
                {
                    <MudText>@L.Resources["pod_notfound"]</MudText>
                }
            </MudAlert>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager RowsPerPageString="@L.Resources["page_pod_per"]" AllItemsText="@L.Resources["page_all"]" PageSizeOptions="@(new int[] { 15, 30, 50, int.MaxValue })" />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<PodInfo> _pods = new();
    private List<PodInfo> _filteredPods = new();
    private List<string> _namespaces = new();
    private bool _isLoading = false;



    private List<PortForwardDefinition> _draftTemplate { get; set; } = new();

    [Parameter]
    public ClusterConnectionInfo? Cluster { get; set; }

    [Parameter]
    public EventCallback<PortForwardDefinition> OnCreateForwardClicked { get; set; }

    [Parameter]
    public EventCallback<PodInfo> OnViewLogsClicked { get; set; }

    [Parameter]
    public EventCallback<PodInfo> OnShowDetailsClicked { get; set; }
    [Parameter]
    public IReadOnlyCollection<PortForwardDefinition>? ExistingForwards { get; set; }
    
    

    
    
    private bool _hasLoaded = false;
    private ClusterConnectionInfo? _previousCluster;



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Cluster != null && !_hasLoaded)
        {
            _hasLoaded = true;
            await LoadPodsAsync();
        }
    }

    protected override void OnParametersSet()
    {
        if (Cluster == null)
        {
            _pods.Clear();
            _filteredPods.Clear();
            _namespaces.Clear();
            _hasLoaded = false;
            _previousCluster = null;
            ClearFilters();
        }
        else if (_previousCluster?.Id != Cluster.Id)
        {
            // Cluster changed, trigger reload and clear filters
            _hasLoaded = false;
            _previousCluster = Cluster;
            ClearFilters();
        }
    }

    private void ClearFilters()
    {
        _ui.SelectedNamespaces = new HashSet<string>();
        _ui.SelectedStatuses = new HashSet<string>();
        _ui.SearchString = null;
    }

    protected override void OnInitialized()
    {
        // Watch for filter changes
        StateHasChanged();
    }

    private void OnNamespacesChanged(IEnumerable<string> values)
    {
        _ui.SelectedNamespaces = values;
        ApplyFilters();
    }

    private void OnStatusesChanged(IEnumerable<string> values)
    {
        _ui.SelectedStatuses = values;
        ApplyFilters();
    }

    private void OnSearchChanged(string value)
    {
        _ui.SearchString = value;
        ApplyFilters();
    }

    private string GetNamespaceSelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return L.Resources["pod_all_namespaces"];
        if (selectedValues.Count == 1)
            return selectedValues.First();
        return $"{selectedValues.Count} {L.Resources["pod_namespaces"]}";
    }

    private string GetStatusSelectionText(List<string> selectedValues)
    {
        if (!selectedValues.Any())
            return L.Resources["pod_all_statuses"];
        if (selectedValues.Count == 1)
            return selectedValues.First();
        return $"{selectedValues.Count} {L.Resources["pod_statuses"]}";
    }


    private async Task LoadPodsAsync()
    {
        if (Cluster == null) return;

        _isLoading = true;
        StateHasChanged();

        try
        {
            _pods = await KubeRepo.ListPodsAsync(Cluster);
            _namespaces = _pods.Select(p => p.Namespace).Distinct().OrderBy(n => n).ToList();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load pods: {ex.Message}");
            _pods.Clear();
            _filteredPods.Clear();
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    public async Task RefreshAsync()
    {
        await LoadPodsAsync();
    }

    private void ApplyFilters()
    {
        _filteredPods = _pods.Where(pod =>
        {
            // Namespace filter (multi-select)
            if (_ui.SelectedNamespaces.Any() && !_ui.SelectedNamespaces.Contains(pod.Namespace))
                return false;

            // Status filter (multi-select)
            if (_ui.SelectedStatuses.Any() && !_ui.SelectedStatuses.Contains(pod.Status.ToString()))
                return false;

            // Search filter
            if (!string.IsNullOrEmpty(_ui.SearchString))
            {
                var search = _ui.SearchString.ToLowerInvariant();
                return pod.Name.ToLowerInvariant().Contains(search) ||
                       pod.Namespace.ToLowerInvariant().Contains(search) ||
                       (pod.NodeName?.ToLowerInvariant().Contains(search) ?? false);
            }

            return true;
        })
        .OrderBy(p => p.Namespace)
        .ThenBy(p => p.Name)
        .ToList();

    }

    

    private void OnViewLogs(PodInfo pod)
    {
        OnViewLogsClicked.InvokeAsync(pod);
    }

    private void OnShowDetails(PodInfo pod)
    {
        OnShowDetailsClicked.InvokeAsync(pod);
    }

    private bool IsForwardDisabled(ContainerPort port, PodInfo pod)
    {
        if (ExistingForwards is null)
        {
            return false;
        }

        return ExistingForwards.Any(fwd =>
            fwd.ResourceType == ResourceType.Pod &&
            string.Equals(fwd.Namespace, pod.Namespace, StringComparison.OrdinalIgnoreCase) &&
            string.Equals(fwd.ResourceName, pod.Name, StringComparison.OrdinalIgnoreCase) &&
            fwd.TargetPort == port.Port);
    }

    private Color GetStatusColor(PodStatus status) => status switch
    {
        PodStatus.Running => Color.Success,
        PodStatus.Pending => Color.Warning,
        PodStatus.Succeeded => Color.Info,
        PodStatus.Failed => Color.Error,
        PodStatus.CrashLoopBackOff => Color.Error,
        PodStatus.ImagePullBackOff => Color.Error,
        _ => Color.Default
    };

    private string GetStatusIcon(PodStatus status) => status switch
    {
        PodStatus.Running => Icons.Material.Filled.CheckCircle,
        PodStatus.Pending => Icons.Material.Filled.Schedule,
        PodStatus.Succeeded => Icons.Material.Filled.Done,
        PodStatus.Failed => Icons.Material.Filled.Error,
        PodStatus.CrashLoopBackOff => Icons.Material.Filled.Loop,
        PodStatus.ImagePullBackOff => Icons.Material.Filled.CloudDownload,
        _ => Icons.Material.Filled.Help
    };

    private string GetAge(DateTimeOffset? startTime)
    {
        if (!startTime.HasValue) return "N/A";
        
        var age = DateTimeOffset.Now - startTime.Value;
        
        if (age.TotalSeconds < 60) return $"{(int)age.TotalSeconds}s";
        if (age.TotalMinutes < 60) return $"{(int)age.TotalMinutes}m";
        if (age.TotalHours < 24) return $"{(int)age.TotalHours}h";
        if (age.TotalDays < 7) return $"{(int)age.TotalDays}d";
        
        return startTime.Value.ToString("MMM dd");
    }
    
    private async Task OpenForwardCreate(ContainerPort cp, PodInfo pod)
    {
        var parameters = new DialogParameters<CreateForwardDialog>
        {
            { x => x._containerPort, cp },
            { x => x._namespace, pod.Namespace },
            { x => x._resourceName, pod.Name },
            { x => x._kind, ResourceType.Pod },
            { x => x._cluster, Cluster },
           
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium };

        var dialog= await DialogService.ShowAsync<CreateForwardDialog>(@L.Forwards["create_forward_title"], parameters, options);
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            //In a real world scenario we would reload the data from the source here since we "removed" it in the dialog already.
            var xxx = result.Data as PortForwardDefinition;
            await OnCreateForwardClicked.InvokeAsync(xxx);
        }

    }
}
