@using KonciergeUi.Client.Components.Layout.Views
@using KonciergeUi.Client.Components.Theme
@using KonciergeUi.Client.State
@using KonciergeUI.Translations.Services
@inherits LayoutComponentBase
@implements IDisposable

@inject UiState Ui



@* Required *@

<MudThemeProvider @ref="_mudThemeProvider"
                  Theme="_theme"
                  IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />
<ErrorBoundary @ref="_errorBoundary">
    <ChildContent>
        <MudLayout>
<MudStack StretchItems="StretchItems.Middle" Style="height: 100vh">
            <!-- TOP APP BAR -->
            <NavMenu _isDark="_isDarkMode" OnThemeChangedAsync="ToggleTheme" />

            <!-- MAIN CONTENT -->
            <MudMainContent @key="_languageKey">
                @Body
            </MudMainContent>
            <Footer></Footer>
</MudStack>
        </MudLayout>
    </ChildContent>
    <ErrorContent Context="ex">
        <MudLayout>
            <MudStack StretchItems="StretchItems.Middle" Style="height: 100vh">
                <NavMenu _isDark="_isDarkMode" OnThemeChangedAsync="ToggleTheme" />
                <MudMainContent>
                    <ErrorView Exception="ex" OnRecover="RecoverFromError" />
                </MudMainContent>
                <Footer></Footer>
            </MudStack>
        </MudLayout>
    </ErrorContent>
</ErrorBoundary>


@code {
    private MudThemeProvider? _mudThemeProvider;
    private ErrorBoundary? _errorBoundary;
    private bool _isDarkMode;
    private string _languageKey = Guid.NewGuid().ToString();

    [Inject] IJSRuntime Js { get; set; } = default!;

    private KoniergeTheme _theme = new();

    protected override async Task OnInitializedAsync()
    {
        Ui.LanguageChanged += OnLanguageChanged;
        // Load saved preferences (theme + language)
        await Ui.LoadPreferencesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _mudThemeProvider is null)
            return;

        // Get system preference
        var systemPrefersDark = await _mudThemeProvider.GetSystemPreference();

        // Apply saved theme preference
        _isDarkMode = Ui.CurrentTheme switch
        {
            "Light" => false,
            "Dark" => true,
            "System" => systemPrefersDark,
            _ => systemPrefersDark  // Default to system
        };

        // Sync to UiState so other components can access the resolved dark mode state
        Ui.IsDarkMode = _isDarkMode;

        // Watch OS changes
        await _mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);

        StateHasChanged();
    }

    private Task OnSystemPreferenceChanged(bool prefersDark)
    {
        // Only auto-switch when user has "System" selected
        if (Ui.CurrentTheme == "System")
        {
            _isDarkMode = prefersDark;
            Ui.IsDarkMode = _isDarkMode;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        Ui.CurrentTheme = _isDarkMode ? "Dark" : "Light";
        Ui.IsDarkMode = _isDarkMode;
        
        await Js.InvokeVoidAsync("koncierge.setThemeClass", _isDarkMode);
        
    }

    private void OnLanguageChanged(object? sender, string culture)
    {
        _languageKey = Guid.NewGuid().ToString();
        InvokeAsync(StateHasChanged);
    }

    private void RecoverFromError()
    {
        _errorBoundary?.Recover();
    }

    public void Dispose()
    {
        Ui.LanguageChanged -= OnLanguageChanged;
    }
}