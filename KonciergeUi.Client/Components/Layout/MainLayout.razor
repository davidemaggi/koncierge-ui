@using KonciergeUi.Client.Components.Theme
@using KonciergeUi.Client.State
@using KonciergeUI.Translations.Services
@inherits LayoutComponentBase

@inject UiState Ui



@* Required *@

<MudThemeProvider @ref="_mudThemeProvider"
                  Theme="_theme"
                  IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />
<ErrorBoundary>
    <ChildContent>
        <MudLayout>

            <!-- TOP APP BAR -->
            <NavMenu _isDark="_isDarkMode" OnThemeChangedAsync="ToggleTheme" />

            <!-- MAIN CONTENT -->
            <MudMainContent >
                @Body
            </MudMainContent>
        </MudLayout>
    </ChildContent>
    
</ErrorBoundary>


@code {
    private MudThemeProvider? _mudThemeProvider;
    private bool _isDarkMode;

    [Inject] IJSRuntime Js { get; set; } = default!;

    private KoniergeTheme _theme = new();

    protected override async Task OnInitializedAsync()
    {
        // Load saved preferences (theme + language)
        await Ui.LoadPreferencesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _mudThemeProvider is null)
            return;

        // Get system preference
        var systemPrefersDark = await _mudThemeProvider.GetSystemPreference();

        // Apply saved theme preference
        _isDarkMode = Ui.CurrentTheme switch
        {
            "Light" => false,
            "Dark" => true,
            "System" => systemPrefersDark,
            _ => systemPrefersDark  // Default to system
        };

        // Watch OS changes
        await _mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);

        StateHasChanged();
    }

    private Task OnSystemPreferenceChanged(bool prefersDark)
    {
        // Only auto-switch when user has "System" selected
        if (Ui.CurrentTheme == "System")
        {
            _isDarkMode = prefersDark;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        Ui.CurrentTheme = _isDarkMode ? "Dark" : "Light";
        
        await Js.InvokeVoidAsync("koncierge.setThemeClass", _isDarkMode);
        
    }
}