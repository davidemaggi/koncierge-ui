@using KonciergeUi.Client.Components.Theme
@using KonciergeUi.Client.Extensions
@using KonciergeUi.Client.Shared
@using KonciergeUI.Models.Forwarding
@using KonciergeUi.Client.State
@using KonciergeUi.Client.Components.Layout.Modals

@inject UiState _ui
@inject IDialogService Dialog


<MudCard Elevation="0" Outlined="false" Style="@(KonciergeColors.GetSummayCardBackground(_ui))">
    <MudStack Row>
        <MudStack>
            <MudStack AlignItems="AlignItems.Center" Row>
                @if (_definition.ResourceType == Enums.ResourceType.Pod)
                {
                    <MudIcon Icon="@KonciergeIcons.Outlined.Pod" Size="Size.Small" Color="Color.Primary"/>
                }
                else
                {
                    <MudIcon Icon="@KonciergeIcons.Outlined.Service" Size="Size.Small" Color="Color.Secondary"/>

                }
                <MudText Style="font-family: monospace;" Typo="Typo.body1">@_definition.ResourceName</MudText>
            </MudStack>
            <MudText Style="font-family: monospace;" Typo="Typo.body2">@($"localhost:{_definition.LocalPort} -> {_definition.TargetPort}({_definition.Protocol.ToString()})")</MudText>
            @if (_definition.LinkedSecrets.Any()) 
            {
                <MudText Style="font-family: monospace;" Typo="Typo.body2">@($"{_definition.LinkedSecrets.Count} linked secret(s)")</MudText>
            }
        </MudStack>
        @if (_showRemove || _showEdit)
        {
            <MudSpacer></MudSpacer>
        }
        @if (_showEdit)
        {
            <MudButton StartIcon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="EditClicked">Edit</MudButton>
        }
        @if(_showRemove){
        <MudButton StartIcon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="RemoveClicked">Remove</MudButton>
        }
    </MudStack>
</MudCard>
@code {
    [Parameter]
    public PortForwardDefinition _definition { get; set; }

    [Parameter] 
    public bool _showRemove { get; set; } = false;

    [Parameter]
    public bool _showEdit { get; set; } = false;

    [Parameter] 
    public EventCallback<Guid> OnForwardRemoveAsync { get; set; }

    [Parameter]
    public EventCallback<PortForwardDefinition> OnForwardUpdated { get; set; }

    private async Task RemoveClicked()
    {

        await Dialog.ShowConfirmationActionAsync( ()=> OnForwardRemoveAsync.InvokeAsync(_definition.Id));
        
       
    }
    private MudTheme Theme = new MudTheme();

    private async Task EditClicked()
    {
        if (_ui.SelectedCluster is null)
        {
            return;
        }

        var parameters = new DialogParameters<CreateForwardDialog>
        {
            { x => x._kind, _definition.ResourceType },
            { x => x._namespace, _definition.Namespace },
            { x => x._resourceName, _definition.ResourceName },
            { x => x._cluster, _ui.SelectedCluster },
            { x => x._existingForward, _definition }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await Dialog.ShowAsync<CreateForwardDialog>("Edit Forward", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PortForwardDefinition updatedForward)
        {
            if (OnForwardUpdated.HasDelegate)
            {
                await OnForwardUpdated.InvokeAsync(updatedForward);
            }
        }
    }


}