@using KonciergeUi.Client.Components.Theme
@using KonciergeUi.Client.Extensions
@using KonciergeUi.Client.Shared
@using KonciergeUI.Models.Forwarding
@using KonciergeUi.Client.State
@using KonciergeUi.Client.Components.Layout.Modals
@using KonciergeUI.Translations.Services
@implements IDisposable

@inject UiState _ui
@inject IDialogService Dialog
@inject ILocalizationService L

<MudCard Elevation="0" Outlined="false" Style="@(KonciergeColors.GetSummaryCardBackground(_ui))">
    <MudStack Row>
        <MudStack>
            <MudStack AlignItems="AlignItems.Center" Row>
                @if (_definition.ResourceType == Enums.ResourceType.Pod)
                {
                    <MudIcon Icon="@KonciergeIcons.Outlined.Pod" Size="Size.Small" Color="Color.Primary"/>
                }
                else
                {
                    <MudIcon Icon="@KonciergeIcons.Outlined.Service" Size="Size.Small" Color="Color.Secondary"/>

                }
                <MudText Style="font-family: monospace;" Typo="Typo.body1">@_definition.ResourceName</MudText>
            </MudStack>
            <MudText Style="font-family: monospace;" Typo="Typo.body2">@GetPortDisplay()</MudText>
            @if (_definition.LinkedSecrets.Any()) 
            {
                <MudText Style="font-family: monospace;" Typo="Typo.body2">@($"{_definition.LinkedSecrets.Count} {L.Forwards["linked_secrets"]}")</MudText>
            }
        </MudStack>
        @if (_showRemove || _showEdit)
        {
            <MudSpacer></MudSpacer>
        }
        @if (_showEdit)
        {
            <MudButton StartIcon="@Icons.Material.Outlined.Edit" Color="Color.Primary" OnClick="EditClicked">@L.Global["crud_edit"]</MudButton>
        }
        @if(_showRemove){
        <MudButton StartIcon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="RemoveClicked">@L.Global["crud_remove"]</MudButton>
        }
    </MudStack>
</MudCard>
@code {
    [Parameter]
    public PortForwardDefinition _definition { get; set; }

    [Parameter] 
    public bool _showRemove { get; set; } = false;

    [Parameter]
    public bool _showEdit { get; set; } = false;

    [Parameter] 
    public EventCallback<Guid> OnForwardRemoveAsync { get; set; }

    [Parameter]
    public EventCallback<PortForwardDefinition> OnForwardUpdated { get; set; }

    protected override void OnInitialized()
    {
        _ui.PropertyChanged += OnUiStateChanged;
    }

    private void OnUiStateChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(UiState.IsDarkMode))
        {
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        _ui.PropertyChanged -= OnUiStateChanged;
    }

    private string GetPortDisplay()
    {
        var localPort = _definition.LocalPort == 0 ? @L.Global["random"] : _definition.LocalPort.ToString();
        return $"localhost:{localPort} -> {_definition.TargetPort}({_definition.Protocol.ToString()})";
    }

    private async Task RemoveClicked()
    {

        await Dialog.ShowConfirmationActionAsync( ()=> OnForwardRemoveAsync.InvokeAsync(_definition.Id));
        
       
    }
    private MudTheme Theme = new MudTheme();

    private async Task EditClicked()
    {
        if (_ui.SelectedCluster is null)
        {
            return;
        }

        var parameters = new DialogParameters<CreateForwardDialog>
        {
            { x => x._kind, _definition.ResourceType },
            { x => x._namespace, _definition.Namespace },
            { x => x._resourceName, _definition.ResourceName },
            { x => x._cluster, _ui.SelectedCluster },
            { x => x._existingForward, _definition }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await Dialog.ShowAsync<CreateForwardDialog>(@L.Forwards["edit_forward_title"], parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is PortForwardDefinition updatedForward)
        {
            if (OnForwardUpdated.HasDelegate)
            {
                await OnForwardUpdated.InvokeAsync(updatedForward);
            }
        }
    }


}