﻿@using KonciergeUi.Client.Components.Layout.Modals
@using KonciergeUi.Client.Extensions
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Data
@using KonciergeUI.Models.Forwarding
@using KonciergeUI.Translations.Services
@inject IPreferencesStorage _storage
@inject IDialogService DialogService
@inject IPortForwardingService _fwdService
@inject ILocalizationService L


<MudCard>
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudIcon Style="font-size: 3rem;" Icon="@KonciergeIcons.Outlined.ActiveForwards" Color="Color.Primary" />
        </CardHeaderAvatar>
        <CardHeaderContent>
        <MudStack AlignItems="AlignItems.Center" Row>
                <MudText Typo="Typo.body1">@_template.Definition.Name</MudText>
                <MudAlert Dense="true" Severity="Severity.Info">@_template.Forwards.Count Forward(s)</MudAlert>


                
            </MudStack>
            </CardHeaderContent>
        <CardHeaderActions>
                    <MudStack AlignItems="AlignItems.Center" Row>
                <MudText Typo="Typo.body2">@L.Global["k8s_context"]: @($"{@_template.ClusterInfo.ContextName}@{@_template.ClusterInfo.Name}")</MudText>

            <MudButton OnClick="StopTemplate" Color="Color.Error" StartIcon="@Icons.Material.Outlined.StopCircle">@L.Templates["cmd_stop"]</MudButton>
            </MudStack>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudStack Spacing="3">
        @foreach (var fwd in _template.Forwards)
        {
            <RunningForwardSummary _cluster="_template.ClusterInfo" _instance="fwd" />
        }
        </MudStack>
    </MudCardContent>
    <MudCardActions>
      
    </MudCardActions>
</MudCard>


@code {


    [Parameter]
    public RunningTemplate _template { get; set; }

    [Parameter]
    public EventCallback<Guid> OnTemplateStopped { get; set; }

    

    private async Task StopTemplate(MouseEventArgs arg)
    {
    
        
                await DialogService.ShowConfirmationActionAsync(async () => 
                {
                    await _fwdService.StopTemplateAsync(_template.TemplateId);
                    await OnTemplateStopped.InvokeAsync(_template.TemplateId);
                });

    }

}