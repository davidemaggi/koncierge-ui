@using KonciergeUi.Client.Components.Layout.Modals
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Data
@using KonciergeUI.Models.Forwarding
@using KonciergeUi.Client.Extensions
@inject IPreferencesStorage _storage
@inject IDialogService DialogService
@inject IPortForwardingService _fwdService


<MudExpansionPanels Elevation="0">
    <MudExpansionPanel>
        <TitleContent>
            <MudStack AlignItems="AlignItems.Center" Row>
                
                    <MudIcon Icon="@KonciergeIcons.Outlined.Templates" Color="Color.Primary" />
                    <MudStack>
                        
                            <MudText Typo="Typo.body1">@_template.Name</MudText>
                     
                        <MudText Typo="Typo.body2">@_template.Description</MudText>
                        <MudStack Row>
                            <MudText Typo="Typo.body2">@_template.Forwards.Count Forward(s)</MudText>
                            <MudText Typo="Typo.body2"> - </MudText>
                            <MudText Typo="Typo.body2">Modified @_template.ModifiedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</MudText>

                        </MudStack>
                    </MudStack>
                    
                <MudSpacer/>
                @{
                    var conflictingPorts = GetConflictingPorts();
                    var hasConflict = conflictingPorts.Any();
                }
                @if (hasConflict)
                {
                    <MudTooltip Text="@($"Port(s) already in use: {string.Join(", ", conflictingPorts)}")">
                        <MudButton Disabled="true" Color="Color.Success" StartIcon="@Icons.Material.Outlined.PlayArrow">Start Template</MudButton>
                    </MudTooltip>
                }
                else
                {
                    <MudButton OnClick="StartTemplate" Color="Color.Success" StartIcon="@Icons.Material.Outlined.PlayArrow">Start Template</MudButton>
                }
                    <MudIconButton Icon="@Icons.Material.Outlined.Edit" Color="Color.Primary"  Size="Size.Small" OnClick="EditTemplate" />
                    <MudIconButton OnClick="DeleteTemplate" Color="Color.Error" Icon="@Icons.Material.Outlined.Delete" />
            </MudStack>
        </TitleContent>
        <ChildContent>
             <MudStack Spacing="10">
            @foreach(var fwd in _template.Forwards) {
                <ForwardSummary _definition="fwd" _showRemove="false"/>
            }
             </MudStack>
        </ChildContent>
    </MudExpansionPanel>
</MudExpansionPanels>
@code {


    [Parameter]
    public ForwardTemplate _template { get; set; }
    [Parameter]
    public EventCallback<ForwardTemplate> OnEditTemplate { get; set; }

    private List<int> GetConflictingPorts()
    {
        // Get all ports currently in use by running forwards
        var portsInUse = _fwdService.GetAllRunningTemplates()
            .SelectMany(t => t.Forwards)
            .Where(f => f.BoundLocalPort.HasValue)
            .Select(f => f.BoundLocalPort!.Value)
            .ToHashSet();

        // Find ports in this template that are non-zero and already in use
        return _template.Forwards
            .Where(f => f.LocalPort != 0 && portsInUse.Contains(f.LocalPort))
            .Select(f => f.LocalPort)
            .Distinct()
            .ToList();
    }

    private async Task DeleteTemplate(MouseEventArgs arg)
    {

        var res= await DialogService.ShowConfirmationAsync();

        if (!res)
            return;

        await _storage.RemoveForwardTemplateAsync(_template.Id);
        StateHasChanged();
    }
    
    private async Task StartTemplate(MouseEventArgs arg)
    {
        var parameters = new DialogParameters<StartForwardDialog>
        {
            { x => x._template, _template },

           
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium };

        var dialog= await DialogService.ShowAsync<StartForwardDialog>("Start Forward", parameters, options);
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            //In a real world scenario we would reload the data from the source here since we "removed" it in the dialog already.
           
        }
    }

    private Task EditTemplate(MouseEventArgs _)
    {
        return OnEditTemplate.HasDelegate ? OnEditTemplate.InvokeAsync(_template) : Task.CompletedTask;
    }

}