@page "/templates"

@using KonciergeUI.Models.Kube
@using KonciergeUi.Client.Components.Layout.FormFields
@using KonciergeUi.Client.Components.Layout.Summaries
@using KonciergeUi.Client.Components.Layout.Views
@using KonciergeUi.Client.State
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Data
@using KonciergeUI.Models.Forwarding
@inject UiState _ui
@inject IPreferencesStorage _storage;
@inject NavigationManager Navigation;

<MudStack Class="ma-4">
    @if (_templates.Any())
    {
        <MudCard>
            <MudCardContent>
                <MudStack Class="d-flex flex-column gap-3">
                    @foreach (var template in _templates)
                    {
                        var index = _templates.IndexOf(template);
                        <MudPaper Class="pa-2 my-1 d-flex align-center flex-grow-1" Elevation="1" Style="width: 100%;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudIconButton
                                    Class="py-1"
                                    Size="Size.Small"
                                    Icon="@Icons.Material.Filled.ArrowUpward"
                                    Disabled="@(index == 0)"
                                    Color="Color.Default"
                                    OnClick="@(() => MoveTemplateAsync(template, -1))" />
                                <MudIconButton
                                    Class="py-1"
                                    Size="Size.Small"
                                    Icon="@Icons.Material.Filled.ArrowDownward"
                                    Disabled="@(index == _templates.Count - 1)"
                                    Color="Color.Default"
                                    OnClick="@(() => MoveTemplateAsync(template, 1))" />
                            </MudStack>
                            <MudIconButton Ripple="false" Size="Size.Small" Color="Color.Primary" Icon="@(template.Favorite ? Icons.Material.Filled.Star : Icons.Material.Filled.StarBorder)" OnClick="@(() => ToggleFavoriteAsync(template))"/>
                            <div class="flex-grow-1">
                                <TemplateSummary _template="template" OnEditTemplate="EditTemplateAsync"/>
                            </div>
                        </MudPaper>
                    }
                </MudStack>
            </MudCardContent>
        </MudCard>
    }
    else
    {
        <NoEntry  _icon="@KonciergeIcons.Outlined.Templates" _title="No templates yet"  _subtitle="Create port forwards in the Resources tab and save them as templates" />

    }
</MudStack>

@code {

    private List<ForwardTemplate> _templates { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        _templates = (await _storage.GetForwardTemplatesAsync())
            .OrderBy(x => x.Sorting)
            .ToList();
    }

    private async Task MoveTemplateAsync(ForwardTemplate template, int direction)
    {
        if (_templates.Count < 2)
        {
            return;
        }

        var currentIndex = _templates.FindIndex(t => t.Id == template.Id);
        if (currentIndex < 0)
        {
            return;
        }

        var targetIndex = currentIndex + direction;
        await MoveTemplateToIndexAsync(template, targetIndex);
    }

    private async Task MoveTemplateToIndexAsync(ForwardTemplate template, int targetIndex)
    {
        if (_templates.Count < 2)
        {
            return;
        }

        var currentIndex = _templates.FindIndex(t => t.Id == template.Id);
        if (currentIndex < 0)
        {
            return;
        }

        if (targetIndex < 0 || targetIndex >= _templates.Count || targetIndex == currentIndex)
        {
            return;
        }

        var now = DateTimeOffset.UtcNow;

        var moved = _templates[currentIndex];
        _templates.RemoveAt(currentIndex);
        _templates.Insert(targetIndex, moved);

        var changedTemplates = new List<ForwardTemplate>();
        for (var i = 0; i < _templates.Count; i++)
        {
            var templateAtIndex = _templates[i];
            if (templateAtIndex.Sorting == i)
            {
                continue;
            }

            var updated = templateAtIndex with { Sorting = i, ModifiedAt = now };
            _templates[i] = updated;
            changedTemplates.Add(updated);
        }

        if (changedTemplates.Count > 0)
        {
            await Task.WhenAll(changedTemplates.Select(_storage.UpdateForwardTemplateAsync));
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleFavoriteAsync(ForwardTemplate template)
    {
        var updatedTemplate = template with { Favorite = !template.Favorite, ModifiedAt = DateTimeOffset.UtcNow };

        await _storage.UpdateForwardTemplateAsync(updatedTemplate);

        // Update the template in the list
        var index = _templates.FindIndex(t => t.Id == template.Id);
        if (index >= 0)
        {
            _templates[index] = updatedTemplate;
        }

        _templates = _templates.OrderBy(t => t.Sorting).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private Task EditTemplateAsync(ForwardTemplate template)
    {
        _ui.SetTemplateDraft(template);
        Navigation.NavigateTo("/");
        return Task.CompletedTask;
    }

}
