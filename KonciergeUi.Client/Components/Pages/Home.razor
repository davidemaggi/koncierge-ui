@page "/"
@using KonciergeUi.Client.State
@using KonciergeUI.Models.Kube
@inject UiState UiState
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.Large" Class="ma-4">
    <!-- Cluster Selector -->
    <MudGrid Spacing="2">
        <MudItem xs="12">
            <MudSelect T="ClusterConnectionInfo?"
                       Label="Select cluster"
                       @bind-Value="UiState.SelectedCluster"
                       Variant="Variant.Outlined"
                       Clearable="true"
                       AdornmentIcon="@Icons.Material.Filled.Cloud">
                
                <MudSelectItem Value="@((ClusterConnectionInfo?)null)">
                    Select a cluster...
                </MudSelectItem>
                
                <MudSelect T="ClusterConnectionInfo" Title="Default kubeconfig (~/.kube/config)">
                    <MudSelectItem Value="@defaultCluster1">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-2" Color="Color.Success" />
                        Default Cluster
                    </MudSelectItem>
                    <MudSelectItem Value="@defaultCluster2">
                        <MudIcon Icon="@Icons.Material.Filled.RadioButtonUnchecked" Size="Size.Small" Class="mr-2" />
                        Production Cluster
                        <MudChip  T="ClusterConnectionInfo" Size="Size.Small" StartIcon="@Icons.Material.Filled.Info" Color="Color.Info" Variant="Variant.Text" Class="ml-2">
                            Current context
                        </MudChip>
                    </MudSelectItem>
                </MudSelect>

                <MudSelect T="ClusterConnectionInfo" Title="Custom kubeconfig: dev-cluster.yaml">
                    <MudSelectItem Value="@customCluster1">
                        <MudIcon Icon="@Icons.Material.Filled.RadioButtonUnchecked" Size="Size.Small" Class="mr-2" />
                        Dev Backend
                        <MudChip T="ClusterConnectionInfo" Size="Size.Small" Icon="@Icons.Material.Filled.Folder" Color="Color.Secondary" Variant="Variant.Text" Class="ml-2">
                            dev-cluster.yaml
                        </MudChip>
                    </MudSelectItem>
                </MudSelect>
            </MudSelect>
        </MudItem>
    </MudGrid>

    @if (UiState.SelectedCluster != null)
    {
        <MudTabs Elevation="2" Rounded="true" PanelClass="pa-4" Class="mt-6">
            
            <!-- PODS TAB -->
            <MudTabPanel Text="Pods (3)">
                <MudTable Items="@mockPods" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                    <HeaderContent>
                        <MudTh>Pod</MudTh>
                        <MudTh>Namespace</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Ports</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Pod">
                            <MudIcon Icon="@Icons.Material.Outlined.GifBox" Color="Color.Primary" Size="Size.Small" Class="mr-2" />
                            @context.Name
                        </MudTd>
                        <MudTd DataLabel="Namespace">@context.Namespace</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Color="@(context.Status == "Running" ? Color.Success : Color.Warning)" 
                                     Size="Size.Small" 
                                     Variant="Variant.Filled">
                                @context.Status
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Ports">
                            @foreach (var port in context.Ports.Take(3))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text" Class="mr-1">@port</MudChip>
                            }
                            @if (context.Ports.Count > 3)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">+@(context.Ports.Count - 3)</MudChip>
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
                                <MudTooltip Text="Port Forward">
                                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small" />
                                </MudTooltip>
                                <MudTooltip Text="Logs">
                                    <MudIconButton Icon="@Icons.Material.Filled.Subject" Color="Color.Default" Size="Size.Small" />
                                </MudTooltip>
                                <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" Size="Size.Small" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>

            <!-- SERVICES TAB -->
            <MudTabPanel Text="Services (2)">
                <MudTable Items="@mockServices" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                    <HeaderContent>
                        <MudTh>Service</MudTh>
                        <MudTh>Namespace</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Ports</MudTh>
                        <MudTh>Selector</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Service">
                            <MudIcon Icon="@Icons.Material.Filled.Smartphone" Color="Color.Secondary" Size="Size.Small" Class="mr-2" />
                            @context.Name
                        </MudTd>
                        <MudTd DataLabel="Namespace">@context.Namespace</MudTd>
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@context.Type</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Ports">@string.Join(", ", context.Ports)</MudTd>
                        <MudTd DataLabel="Selector">@string.Join(", ", context.Selector.Take(2))@(context.Selector.Count > 2 ? "..." : "")</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
                                <MudTooltip Text="Port Forward">
                                    <MudButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Small" />
                                </MudTooltip>
                                <MudTooltip Text="Endpoints">
                                    <MudButton Icon="@Icons.Material.Outlined.Pause" Color="Color.Default" Size="Size.Small" />
                                </MudTooltip>
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>
    }
    else
    {
        <MudPaper Class="pa-8 mud-theme-primary pa-16 text-center mt-12" Elevation="3">
            <MudIcon Icon="@Icons.Material.Filled.CloudOff" Color="Color.Warning" Size="Size.Large" />
            <MudText Typo="Typo.h5" Class="mt-4 mb-2">No cluster selected</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Select a cluster from the dropdown above to view pods and services.
            </MudText>
        </MudPaper>
    }
</MudContainer>

@code {
    // Mock clusters (using your existing models)
    private ClusterConnectionInfo defaultCluster1 = new()
    {
        Id = "default-1",
        Name = "Default Cluster",
        KubeconfigPath = "~/.kube/config",
        ContextName = "default-cluster",
        IsCurrentContext = false,
        IsDefaultKubeconfig = true
    };

    private ClusterConnectionInfo defaultCluster2 = new()
    {
        Id = "default-2",
        Name = "Production Cluster",
        KubeconfigPath = "~/.kube/config",
        ContextName = "production",
        IsCurrentContext = true,
        IsDefaultKubeconfig = true,
        Description = "Current context"
    };

    private ClusterConnectionInfo customCluster1 = new()
    {
        Id = "custom-1",
        Name = "Dev Backend",
        KubeconfigPath = "/path/to/dev-cluster.yaml",
        ContextName = "dev-backend",
        IsDefaultKubeconfig = false
    };

    // Mock table data
    private List<PodInfo> mockPods = new()
    {
        new() { Name = "frontend-app-7b5f8d9f4-xyz12", Namespace = "default", Status = "Running", Ports = new() { "80", "443" } },
        new() { Name = "backend-api-5c4d2e1f3-abc45", Namespace = "default", Status = "Running", Ports = new() { "8080", "8443" } },
        new() { Name = "database-cache-9a8b7c6d5-def23", Namespace = "cache", Status = "Running", Ports = new() { "6379", "6380" } }
    };

    private List<ServiceInfo> mockServices = new()
    {
        new() { Name = "frontend", Namespace = "default", Type = "ClusterIP", Ports = new() { "80" }, Selector = new() { "app=frontend" } },
        new() { Name = "backend-api", Namespace = "default", Type = "LoadBalancer", Ports = new() { "80:8080/TCP" }, Selector = new() { "app=backend", "tier=api" } }
    };

    public record PodInfo
    {
        public string Name { get; init; } = string.Empty;
        public string Namespace { get; init; } = string.Empty;
        public string Status { get; init; } = string.Empty;
        public List<string> Ports { get; init; } = new();
    }

    public record ServiceInfo
    {
        public string Name { get; init; } = string.Empty;
        public string Namespace { get; init; } = string.Empty;
        public string Type { get; init; } = string.Empty;
        public List<string> Ports { get; init; } = new();
        public List<string> Selector { get; init; } = new();
    }

    protected override void OnInitialized()
    {
        UiState.PropertyChanged += (s, e) => StateHasChanged();
    }

    public void Dispose()
    {
        UiState.PropertyChanged -= (s, e) => StateHasChanged();
    }
}
