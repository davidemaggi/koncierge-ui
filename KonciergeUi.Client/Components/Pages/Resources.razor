@page "/"

@using KonciergeUI.Models.Kube
@using KonciergeUi.Client.Components.Layout.FormFields
@using KonciergeUi.Client.Components.Layout.Modals
@using KonciergeUi.Client.Components.Layout.Summaries
@using KonciergeUi.Client.Components.Layout.Tables
@using KonciergeUi.Client.Components.Layout.Views
@using KonciergeUi.Client.Shared
@using KonciergeUi.Client.State
@using KonciergeUI.Core.Abstractions
@using KonciergeUI.Models.Forwarding
@using KonciergeUI.Translations.Services
@using OneOf.Types
@using KonciergeUI.Data
@using Microsoft.Maui.Storage
@using System.IO
@inject UiState _ui
@inject IPortForwardingService _fwd;
@inject IDialogService DialogService;
@inject ISnackbar Snackbar;
@inject ILocalizationService L
@inject IClusterDiscoveryService _clusterDiscoveryService;
@inject IPreferencesStorage _preferencesStorage;

<MudStack Class="ma-4">
    <MudGrid Spacing="2">
        <MudItem xs="12">
            <MudStack Row="true" Spacing="2"  AlignItems="AlignItems.Center" StretchItems="StretchItems.StartAndEnd">
                <ClusterSelect SelectedCluster="_ui.SelectedCluster" _onClusterSelection="OnClusterSelection"  />
           
                <MudButton OnClick="OpenAddKubeconfig" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
                    @L.Resources["add_kubeconfig"]
                </MudButton>
                <MudSpacer/>
            </MudStack>
        </MudItem>
    </MudGrid>
    @if (_currentTemplate.Forwards.Count>0)
    {
        <MudCard>
            <MudCardContent>
                <MudStack>
                    <MudText Typo="Typo.h5" Class="mt-4 mb-2">@_currentTemplate.Name @($"({_currentTemplate.Forwards.Count})")</MudText>
                    
                    <MudGrid>
                        @foreach (var fwd in _currentTemplate.Forwards)
                        {
                            <MudItem xs="12">
                                <ForwardSummary _definition="fwd" _showRemove="true" OnForwardRemoveAsync="RemoveForwardFromList"/>
                            </MudItem>
                        }

                    </MudGrid>
                </MudStack>
            </MudCardContent>
            <MudCardActions>
                <MudButton OnClick="StartForward"  StartIcon="@Icons.Material.Filled.PlayArrow" Color="Color.Success">@L.Resources["start_forward"]</MudButton>
                <MudButton OnClick="OnSaveClick" StartIcon="@Icons.Material.Filled.Save" Color="Color.Primary">@L.Resources["crete_template"]</MudButton>

            </MudCardActions>
        </MudCard>
    }
    @if (_ui.SelectedCluster != null)
    {
        <MudTabs Elevation="2" Rounded="true" Class="mt-4" ApplyEffectsToContainer="true">
            <MudTabPanel Text="@L.Resources["tab_pods"]" Icon="@KonciergeIcons.Outlined.Pod">
                <PodsList Cluster="@_ui.SelectedCluster"
                          OnCreateForwardClicked="HandleCreateForward"
                          OnViewLogsClicked="HandleViewLogs"
                          OnShowDetailsClicked="HandleShowDetails" />
            </MudTabPanel>
            
            <MudTabPanel Text="@L.Resources["tab_services"]" Icon="@KonciergeIcons.Outlined.Service">
                <ServicesList Cluster="@_ui.SelectedCluster"
                              OnCreateForwardClicked="HandleCreateForward" />
            </MudTabPanel>
        </MudTabs>
    }
    else
    {
        <NoEntry  _icon="@KonciergeIcons.Outlined.Resources" _title="@L.Resources["empty_title"]"  _subtitle="@L.Resources["empty_subtitle"]" />

    }
</MudStack>

@code {

    private ForwardTemplate _currentTemplate { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
    }

    private async Task OnClusterSelection(ClusterConnectionInfo? sel)
    {

   
        _ui.SelectedCluster = sel;

    }

    private void HandleCreateForward(PodInfo pod)
    {
        Console.WriteLine($"Create forward for pod: {pod.Name}");
        // TODO: Open port forward dialog
    }

    private void HandleViewLogs(PodInfo pod)
    {
        Console.WriteLine($"View logs for pod: {pod.Name}");
        // TODO: Open logs viewer
    }

    private void HandleShowDetails(PodInfo pod)
    {
        Console.WriteLine($"Show details for pod: {pod.Name}");
        // TODO: Open details dialog
    }

    private void HandleCreateForward(PortForwardDefinition req)
    {

        if (req.LocalPort!=0 && _currentTemplate.Forwards.Any(x=>x.LocalPort==req.LocalPort))
        {
            Snackbar.Add(L.Errors["forward_same_port"], Severity.Error);

        }
        else
        {
        Snackbar.Add("Forward Created", Severity.Success);
        _currentTemplate.Forwards.Add(req);
            
        }


    }

    private void RemoveForwardFromList(Guid toRemove)
    {
        _currentTemplate.Forwards.RemoveAll(fwd => fwd.Id != toRemove);
        StateHasChanged();
    }

   
    private async Task StartForward()
    {
        
        
        
        
        var parameters = new DialogParameters<StartForwardDialog>
        {
            { x => x._template, _currentTemplate },

           
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium };

        var dialog= await DialogService.ShowAsync<StartForwardDialog>("Start Forward", parameters, options);
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            //In a real world scenario we would reload the data from the source here since we "removed" it in the dialog already.
           
        }

    }
    
    
    private async Task OnSaveClick()
    {
        
        
        
        
        var parameters = new DialogParameters<SaveTemplateDialog>
        {
            { x => x._template, _currentTemplate },

           
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium };

        var dialog= await DialogService.ShowAsync<SaveTemplateDialog>("SaveTemplate", parameters, options);
        
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            _currentTemplate = new();
        }

    }

    
    private async Task OpenAddKubeconfig()
    {
        var parameters = new DialogParameters<FilePickerDialog>
        {
            { x => x._multi, false },
            { x => x._amount, 1 },

           
        };

        var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Medium };

        var dialog= await DialogService.ShowAsync<FilePickerDialog>(null, parameters, options);
        
        var result = await dialog.Result;

        if (result.Canceled || result.Data is not List<string> filePaths || filePaths.Count == 0)
        {
            return;
        }
 
        foreach (var path in filePaths)
        {
            var validation = await ValidateKubeconfigAsync(path);

            if (!validation.Success)
            {
                Snackbar.Add(validation.ErrorMessage ?? $"{Path.GetFileName(path)} is not a valid kubeconfig.", Severity.Error);
                continue;
            }

            await _preferencesStorage.AddCustomKubeconfigPathAsync(path);
            Snackbar.Add($"{Path.GetFileName(path)} imported successfully.", Severity.Success);
         }
      }
 
    private async Task<(bool Success, string? ErrorMessage)> ValidateKubeconfigAsync(string path)
    {
        try
        {
            await using var stream = File.OpenRead(path);
            if (!_clusterDiscoveryService.IsValidKubeconfig(stream))
            {
                return (false, $"{Path.GetFileName(path)} is not a valid kubeconfig file.");
            }

            return (true, null);
        }
        catch (Exception ex)
        {
            return (false, $"Failed to validate {Path.GetFileName(path)}: {ex.Message}");
        }
    }
}
