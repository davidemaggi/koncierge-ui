name: release-windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.100'
          global-json-file: global.json

      - name: Install GitVersion.Tool
        run: dotnet tool install --global GitVersion.Tool --version 6.5.1

      - name: Evaluate version
        id: gitversion
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $json = dotnet-gitversion /output json
          $data = $json | ConvertFrom-Json
          "semver=$($data.SemVer)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "nugetversion=$($data.NuGetVersionV2)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "majorminorpatch=$($data.MajorMinorPatch)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Install MAUI workloads
        run: |
          dotnet workload install maui maui-windows

      - name: Restore solution
        run: dotnet restore KonciergeUi.sln

      - name: Publish Windows self-contained (zip)
        run: >-
          dotnet publish KonciergeUi.Client/KonciergeUi.Client.csproj
          -c Release
          -f net9.0-windows10.0.19041.0
          -p:RuntimeIdentifierOverride=win10-x64
          -p:WindowsPackageType=None
          -p:WindowsAppSDKSelfContained=true
          -p:WindowsAppSDKSelfContainedPlatforms=x64
          -p:PublishTrimmed=false
          -p:ApplicationDisplayVersion=${{ steps.gitversion.outputs.majorminorpatch }}


      - name: Package artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $publishDir = Join-Path $env:GITHUB_WORKSPACE 'KonciergeUi.Client/bin/Release/net9.0-windows10.0.19041.0/win10-x64/publish'
          if (-not (Test-Path $publishDir)) {
            throw "Publish directory not found: $publishDir"
          }
          $artifacts = Join-Path $env:GITHUB_WORKSPACE 'artifacts'
          New-Item -ItemType Directory -Force -Path $artifacts | Out-Null
          $zipPath = Join-Path $artifacts "KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          $itemsToZip = Get-ChildItem -Path $publishDir -Force
          Compress-Archive -Path $itemsToZip -DestinationPath $zipPath

          "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Calculate ZIP hash
        id: hash
        shell: pwsh
        run: |
          $zipPath = "${{ steps.package.outputs.zip_path }}"
          $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash
          "sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "SHA256: $hash" -ForegroundColor Cyan

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.gitversion.outputs.semver }}
          name: Koncierge UI ${{ steps.gitversion.outputs.semver }}
          body: |
            ## Changes
            Automated Windows build via GitHub Actions.
            
            ## Installation
            
            ### Via WinGet (recommended)
            Once the package is available in the WinGet repository:
            ```powershell
            winget install DavideMaggi.KonciergeUI
            ```
            
            ### Manual Installation
            1. Download `KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip`
            2. Extract to a folder of your choice
            3. Run `KonciergeUi.Client.exe`
            
            ### SHA256 Checksum
            `${{ steps.hash.outputs.sha256 }}`
          files: |
            ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install WinGetCreate
        shell: pwsh
        run: |
          # Download latest wingetcreate
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/microsoft/winget-create/releases/latest"
          $asset = $releases.assets | Where-Object { $_.name -eq "wingetcreate.exe" }
          $downloadUrl = $asset.browser_download_url
          
          $toolsDir = Join-Path $env:GITHUB_WORKSPACE "tools"
          New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null
          
          Invoke-WebRequest -Uri $downloadUrl -OutFile (Join-Path $toolsDir "wingetcreate.exe")
          Write-Host "✓ WinGetCreate downloaded to $toolsDir" -ForegroundColor Green

      - name: Generate WinGet manifest with WinGetCreate
        id: winget
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          $version = "${{ steps.gitversion.outputs.semver }}"
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "${{ github.event.repository.name }}"
          $installerUrl = "https://github.com/$repoOwner/$repoName/releases/download/v$version/KonciergeUi-win-$version.zip"
          
          $wingetcreate = Join-Path $env:GITHUB_WORKSPACE "tools/wingetcreate.exe"
          $manifestDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/winget-manifest"
          New-Item -ItemType Directory -Force -Path $manifestDir | Out-Null
          
          Write-Host "Creating manifest for version $version" -ForegroundColor Cyan
          Write-Host "Installer URL: $installerUrl" -ForegroundColor Cyan
          
          # Use wingetcreate to generate/update the manifest
          # For new packages, use 'new'. For updates, use 'update'
          & $wingetcreate new $installerUrl `
            --package-identifier "DavideMaggi.KonciergeUI" `
            --package-version $version `
            --package-locale "en-US" `
            --publisher "Davide Maggi" `
            --package-name "Koncierge UI" `
            --license "MIT" `
            --short-description "A Kubernetes port-forwarding manager with a modern UI" `
            --output $manifestDir `
            --windows-desktop
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "wingetcreate new failed, trying update mode..." -ForegroundColor Yellow
            & $wingetcreate update "DavideMaggi.KonciergeUI" `
              --urls $installerUrl `
              --version $version `
              --output $manifestDir
          }
          
          Write-Host "✓ WinGet manifest generated in $manifestDir" -ForegroundColor Green
          Get-ChildItem -Path $manifestDir -Recurse | ForEach-Object { Write-Host "  - $($_.FullName)" }
          
          "manifest_dir=$manifestDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Submit to WinGet repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.WINGET_AUTO_SUBMIT == 'true'
        shell: pwsh
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          if ([string]::IsNullOrEmpty($env:WINGET_GITHUB_TOKEN)) {
            Write-Host "WINGET_GITHUB_TOKEN not configured - skipping automatic submission" -ForegroundColor Yellow
            Write-Host "To enable automatic submission:" -ForegroundColor Yellow
            Write-Host "  1. Create a GitHub PAT with 'public_repo' scope" -ForegroundColor Gray
            Write-Host "  2. Add it as a repository secret named 'WINGET_GITHUB_TOKEN'" -ForegroundColor Gray
            Write-Host "  3. Create a repository variable 'WINGET_AUTO_SUBMIT' with value 'true'" -ForegroundColor Gray
            exit 0
          }
          
          $version = "${{ steps.gitversion.outputs.semver }}"
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "${{ github.event.repository.name }}"
          $installerUrl = "https://github.com/$repoOwner/$repoName/releases/download/v$version/KonciergeUi-win-$version.zip"
          
          $wingetcreate = Join-Path $env:GITHUB_WORKSPACE "tools/wingetcreate.exe"
          
          Write-Host "Submitting manifest to winget-pkgs repository..." -ForegroundColor Cyan
          
          # Submit directly to winget-pkgs (creates a PR automatically)
          & $wingetcreate update "DavideMaggi.KonciergeUI" `
            --urls $installerUrl `
            --version $version `
            --submit `
            --token $env:WINGET_GITHUB_TOKEN
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ Successfully submitted PR to microsoft/winget-pkgs" -ForegroundColor Green
          } else {
            Write-Warning "Failed to submit to winget-pkgs. You can manually submit using the manifest artifact."
          }

      - name: Upload WinGet manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifest-${{ steps.gitversion.outputs.semver }}
          path: ${{ steps.winget.outputs.manifest_dir }}
          retention-days: 90
