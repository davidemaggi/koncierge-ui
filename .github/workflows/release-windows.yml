name: release-windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install GitVersion.Tool
        run: dotnet tool install --global GitVersion.Tool --version 6.5.1

      - name: Evaluate version
        id: gitversion
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $json = dotnet-gitversion /output json
          $data = $json | ConvertFrom-Json
          "semver=$($data.SemVer)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "nugetversion=$($data.NuGetVersionV2)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Install MAUI workloads
        run: |
          dotnet workload install maui maui-windows

      - name: Restore solution
        run: dotnet restore KonciergeUi.sln

      - name: Publish Windows self-contained (zip)
        run: >-
          dotnet publish KonciergeUi.Client/KonciergeUi.Client.csproj
          -c Release
          -f net9.0-windows10.0.19041.0
          -r win10-x64
          --self-contained true
          -p:PublishTrimmed=false
          -p:WindowsPackageType=None
          -p:ApplicationDisplayVersion=${{ steps.gitversion.outputs.semver }}

      - name: Publish Windows MSI
        run: >-
          dotnet publish KonciergeUi.Client/KonciergeUi.Client.csproj
          -c Release
          -f net9.0-windows10.0.19041.0
          -r win10-x64
          --self-contained true
          -p:PublishTrimmed=false
          -p:WindowsPackageType=msi
          -p:ApplicationDisplayVersion=${{ steps.gitversion.outputs.semver }}

      - name: Package artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $publishDir = Join-Path $env:GITHUB_WORKSPACE 'KonciergeUi.Client/bin/Release/net9.0-windows10.0.19041.0/win10-x64/publish'
          if (-not (Test-Path $publishDir)) {
            throw "Publish directory not found: $publishDir"
          }
          $artifacts = Join-Path $env:GITHUB_WORKSPACE 'artifacts'
          New-Item -ItemType Directory -Force -Path $artifacts | Out-Null
          $zipPath = Join-Path $artifacts "KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          $itemsToZip = Get-ChildItem -Path $publishDir -Force
          Compress-Archive -Path $itemsToZip -DestinationPath $zipPath

          $msiPath = Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE 'KonciergeUi.Client/bin/Release/net9.0-windows10.0.19041.0/win10-x64/AppPackages') -Recurse -Filter '*.msi' | Select-Object -First 1
          if (-not $msiPath) {
            throw 'MSI artifact not found'
          }

          "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "msi_path=$($msiPath.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.gitversion.outputs.semver }}
          name: Koncierge UI ${{ steps.gitversion.outputs.semver }}
          body: |
            ## Changes
            Automated Windows build via GitHub Actions.
          files: |
            ${{ steps.package.outputs.zip_path }}
            ${{ steps.package.outputs.msi_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
