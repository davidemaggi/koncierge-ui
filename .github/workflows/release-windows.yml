name: release-windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      GITVERSION_BRANCH: main
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show git context
        shell: pwsh
        run: |
          git --no-pager log -5 --oneline
          git --no-pager describe --tags --abbrev=0 --match "v[0-9]*" 2>$null

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.100'
          global-json-file: global.json

      - name: Install GitVersion.Tool
        run: dotnet tool install --global GitVersion.Tool --version 6.5.1

      - name: Evaluate version
        id: gitversion
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $json = dotnet-gitversion /output json
          $data = $json | ConvertFrom-Json
          $semver = $data.SemVer
          $nugetversion = $data.NuGetVersionV2
          $majorminorpatch = $data.MajorMinorPatch

          if ([string]::IsNullOrWhiteSpace($majorminorpatch)) {
            try {
              $tag = (git describe --tags --abbrev=0 --match "v[0-9]*" 2>$null).Trim()
            } catch {
              $tag = ""
            }

            if ([string]::IsNullOrWhiteSpace($tag)) {
              $base = "0.0.0"
            } else {
              $base = $tag.TrimStart('v')
            }

            $parts = $base.Split('.')
            if ($parts.Length -lt 3) {
              $parts = @($parts[0], $parts[1], '0')
            }

            $patch = [int]$parts[2] + 1
            $majorminorpatch = "$($parts[0]).$($parts[1]).$patch"
            $semver = $majorminorpatch
            $nugetversion = $majorminorpatch
          }

          "semver=$semver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "nugetversion=$nugetversion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "majorminorpatch=$majorminorpatch" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Show GitVersion values
        shell: pwsh
        run: |
          Write-Host "SemVer: ${{ steps.gitversion.outputs.semver }}"
          Write-Host "MajorMinorPatch: ${{ steps.gitversion.outputs.majorminorpatch }}"
          Write-Host "NuGetVersionV2: ${{ steps.gitversion.outputs.nugetversion }}"

      - name: Install MAUI workloads
        run: |
          dotnet workload install maui maui-windows

      - name: Restore solution
        run: dotnet restore KonciergeUi.sln

      - name: Publish Windows self-contained (zip)
        run: >-
          dotnet publish KonciergeUi.Client/KonciergeUi.Client.csproj
          -c Release
          -f net9.0-windows10.0.19041.0
          -p:RuntimeIdentifierOverride=win10-x64
          -p:WindowsPackageType=None
          -p:WindowsAppSDKSelfContained=true
          -p:WindowsAppSDKSelfContainedPlatforms=x64
          -p:PublishTrimmed=false
          -p:ApplicationDisplayVersion=${{ steps.gitversion.outputs.majorminorpatch }}

      - name: Convert SVG icon to ICO
        shell: pwsh
        run: |
          # Install ImageMagick for icon conversion
          choco install imagemagick -y --no-progress
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Use the project image from Resources/Images as the source SVG
          $svgPath = "KonciergeUi.Client/Resources/Images/koncierge_logo.svg"
          $icoPath = "KonciergeUi.Client/Resources/AppIcon/appicon.ico"

          # Ensure destination directory exists
          $destDir = Split-Path -Path $icoPath
          if (!(Test-Path $destDir)) {
            New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          }
          
          # Convert SVG to ICO with multiple sizes
          magick convert -background none -density 256 $svgPath -define icon:auto-resize=256,128,64,48,32,16 $icoPath
          Write-Host "‚úì Icon converted to ICO format" -ForegroundColor Green

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress
          Write-Host "‚úì Inno Setup installed" -ForegroundColor Green

      - name: Build Inno Setup installer
        id: inno
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $publishDir = Join-Path $env:GITHUB_WORKSPACE 'KonciergeUi.Client/bin/Release/net9.0-windows10.0.19041.0/win10-x64/publish'
          $version = "${{ steps.gitversion.outputs.majorminorpatch }}"
          
          # Run Inno Setup compiler
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          & $iscc /DMyAppVersion=$version /DMyAppSourceDir=$publishDir "installer/konciergeui.iss"
          
          $setupPath = Join-Path $env:GITHUB_WORKSPACE "artifacts/KonciergeUI-setup-$version.exe"
          if (-not (Test-Path $setupPath)) {
            throw "Installer not found: $setupPath"
          }
          
          "setup_path=$setupPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "‚úì Inno Setup installer created: $setupPath" -ForegroundColor Green

      - name: Calculate installer hash
        id: setup_hash
        shell: pwsh
        run: |
          $setupPath = "${{ steps.inno.outputs.setup_path }}"
          $hash = (Get-FileHash -Path $setupPath -Algorithm SHA256).Hash
          "sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Setup SHA256: $hash" -ForegroundColor Cyan


      - name: Package artifacts
        id: package
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $publishDir = Join-Path $env:GITHUB_WORKSPACE 'KonciergeUi.Client/bin/Release/net9.0-windows10.0.19041.0/win10-x64/publish'
          if (-not (Test-Path $publishDir)) {
            throw "Publish directory not found: $publishDir"
          }
          $artifacts = Join-Path $env:GITHUB_WORKSPACE 'artifacts'
          New-Item -ItemType Directory -Force -Path $artifacts | Out-Null
          $zipPath = Join-Path $artifacts "KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          $itemsToZip = Get-ChildItem -Path $publishDir -Force
          Compress-Archive -Path $itemsToZip -DestinationPath $zipPath

          "zip_path=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Calculate ZIP hash
        id: hash
        shell: pwsh
        run: |
          $zipPath = "${{ steps.package.outputs.zip_path }}"
          $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash
          "sha256=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "SHA256: $hash" -ForegroundColor Cyan

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.gitversion.outputs.majorminorpatch }}
          name: Koncierge ${{ steps.gitversion.outputs.semver }}
          body: |
            ## Koncierge ${{ steps.gitversion.outputs.semver }}
            
            Automated Windows build via GitHub Actions.
            
            ---
            
            ## üñ•Ô∏è Koncierge UI (Desktop App)
            
            A modern, cross-platform Kubernetes port-forwarding manager with a beautiful UI.
            
            ### Installation
            
            #### Via WinGet (recommended)
            ```powershell
            winget install DavideMaggi.KonciergeUI
            ```
            
            #### Via Chocolatey
            ```powershell
            choco install konciergeui
            ```
            
            #### Installer (with desktop shortcut)
            1. Download `KonciergeUI-setup-${{ steps.gitversion.outputs.majorminorpatch }}.exe`
            2. Run the installer
            3. A desktop shortcut will be created
            
            #### Manual Installation (portable)
            1. Download `KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip`
            2. Extract to a folder of your choice
            3. Run `KonciergeUI.exe`
            
            ---
            
            ## ‚å®Ô∏è Koncierge CLI (Command Line)
            
            A powerful CLI tool for managing Kubernetes port-forwards.
            
            ### Installation
            
            #### Via WinGet (recommended)
            ```powershell
            winget install DavideMaggi.Koncierge
            ```
            
            #### Via Chocolatey
            ```powershell
            choco install koncierge
            ```
            
            #### Installer (with PATH registration)
            1. Download `Koncierge-cli-setup-${{ steps.gitversion.outputs.majorminorpatch }}.exe`
            2. Run the installer
            3. The `koncierge` command will be added to your PATH
            
            #### Manual Installation (portable)
            1. Download `Koncierge-cli-win-${{ steps.gitversion.outputs.semver }}.zip`
            2. Extract to a folder of your choice
            3. Add the folder to your PATH or run `Koncierge.exe` directly
            
            ---
            
            ## SHA256 Checksums
            
            ### UI
            - Installer: `${{ steps.setup_hash.outputs.sha256 }}`
            - ZIP: `${{ steps.hash.outputs.sha256 }}`
            
            ### CLI
            _(See CLI workflow output for checksums)_
          files: |
            ${{ steps.inno.outputs.setup_path }}
            ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install WinGetCreate
        shell: pwsh
        run: |
          # Download latest wingetcreate
          $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/microsoft/winget-create/releases/latest"
          $asset = $releases.assets | Where-Object { $_.name -eq "wingetcreate.exe" }
          $downloadUrl = $asset.browser_download_url
          
          $toolsDir = Join-Path $env:GITHUB_WORKSPACE "tools"
          New-Item -ItemType Directory -Force -Path $toolsDir | Out-Null
          
          Invoke-WebRequest -Uri $downloadUrl -OutFile (Join-Path $toolsDir "wingetcreate.exe")
          Write-Host "‚úì WinGetCreate downloaded to $toolsDir" -ForegroundColor Green

      - name: Generate WinGet manifest with WinGetCreate
        id: winget
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          
          $version = "${{ steps.gitversion.outputs.majorminorpatch }}"
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "${{ github.event.repository.name }}"
          $installerUrl = "https://github.com/$repoOwner/$repoName/releases/download/v${{ steps.gitversion.outputs.majorminorpatch }}/KonciergeUI-setup-$version.exe"
          
          $wingetcreate = Join-Path $env:GITHUB_WORKSPACE "tools/wingetcreate.exe"
          $manifestDir = Join-Path $env:GITHUB_WORKSPACE "artifacts/winget-manifest"
          New-Item -ItemType Directory -Force -Path $manifestDir | Out-Null
          
          Write-Host "Creating manifest for version $version" -ForegroundColor Cyan
          Write-Host "Installer URL: $installerUrl" -ForegroundColor Cyan
          
          # Try to create new manifest first (for first-time submission)
          # wingetcreate new requires interactive mode or existing package, so we create manually
          $packageId = "DavideMaggi.KonciergeUI"
          $manifestVersionDir = Join-Path $manifestDir "$packageId/$version"
          New-Item -ItemType Directory -Force -Path $manifestVersionDir | Out-Null
          
          # Create version manifest
          @"
          PackageIdentifier: $packageId
          PackageVersion: $version
          DefaultLocale: en-US
          ManifestType: version
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath (Join-Path $manifestVersionDir "$packageId.yaml") -Encoding utf8NoBOM
          
          # Create installer manifest (using Inno Setup installer)
          $sha256 = "${{ steps.setup_hash.outputs.sha256 }}"
          @"
          PackageIdentifier: $packageId
          PackageVersion: $version
          MinimumOSVersion: 10.0.17763.0
          InstallerType: inno
          Scope: user
          InstallerSwitches:
            Silent: /VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-
            SilentWithProgress: /SILENT /SUPPRESSMSGBOXES /NORESTART /SP-
            InstallLocation: /DIR="<INSTALLPATH>"
            Custom: /TASKS=desktopicon,addtopath
          Commands:
            - konciergeui
          Installers:
            - Architecture: x64
              InstallerUrl: $installerUrl
              InstallerSha256: $sha256
          ManifestType: installer
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath (Join-Path $manifestVersionDir "$packageId.installer.yaml") -Encoding utf8NoBOM
          
          # Create locale manifest
          @"
          PackageIdentifier: $packageId
          PackageVersion: $version
          PackageLocale: en-US
          Publisher: Davide Maggi
          PublisherUrl: https://github.com/$repoOwner
          PublisherSupportUrl: https://github.com/$repoOwner/$repoName/issues
          PackageName: Koncierge UI
          PackageUrl: https://github.com/$repoOwner/$repoName
          License: MIT
          LicenseUrl: https://github.com/$repoOwner/$repoName/blob/main/LICENSE
          ShortDescription: A Kubernetes port-forwarding manager with a modern UI
          Description: Koncierge UI is a cross-platform application for managing Kubernetes port forwards. It provides an intuitive interface for viewing pods, services, and managing port forwarding sessions.
          Tags:
            - kubernetes
            - k8s
            - port-forward
            - devops
            - cloud
            - containers
          ManifestType: defaultLocale
          ManifestVersion: 1.6.0
          "@ | Out-File -FilePath (Join-Path $manifestVersionDir "$packageId.locale.en-US.yaml") -Encoding utf8NoBOM
          
          Write-Host "‚úì WinGet manifest generated in $manifestVersionDir" -ForegroundColor Green
          Get-ChildItem -Path $manifestVersionDir | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          "manifest_dir=$manifestDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "manifest_version_dir=$manifestVersionDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Submit to WinGet repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.WINGET_AUTO_SUBMIT == 'true'
        shell: pwsh
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Continue'
          
          if ([string]::IsNullOrEmpty($env:WINGET_GITHUB_TOKEN)) {
            Write-Host "WINGET_GITHUB_TOKEN not configured - skipping automatic submission" -ForegroundColor Yellow
            Write-Host "To enable automatic submission:" -ForegroundColor Yellow
            Write-Host "  1. Create a GitHub PAT with 'public_repo' scope" -ForegroundColor Gray
            Write-Host "  2. Add it as a repository secret named 'WINGET_GITHUB_TOKEN'" -ForegroundColor Gray
            Write-Host "  3. Create a repository variable 'WINGET_AUTO_SUBMIT' with value 'true'" -ForegroundColor Gray
            exit 0
          }
          
          $version = "${{ steps.gitversion.outputs.majorminorpatch }}"
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "${{ github.event.repository.name }}"
          $installerUrl = "https://github.com/$repoOwner/$repoName/releases/download/v${{ steps.gitversion.outputs.majorminorpatch }}/KonciergeUI-setup-$version.exe"
          
          $wingetcreate = Join-Path $env:GITHUB_WORKSPACE "tools/wingetcreate.exe"
          $manifestVersionDir = "${{ steps.winget.outputs.manifest_version_dir }}"
          
          Write-Host "Submitting manifest to winget-pkgs repository..." -ForegroundColor Cyan
          
          # For existing packages in winget-pkgs, use update --submit
          # For new packages, we need to submit the manifest files manually via PR
          # Try update first (will work if package already exists in winget-pkgs)
          $output = & $wingetcreate update "DavideMaggi.KonciergeUI" `
            --urls $installerUrl `
            --version $version `
            --submit `
            --token $env:WINGET_GITHUB_TOKEN 2>&1
          
          $updateExitCode = $LASTEXITCODE
          Write-Host $output
          
          if ($updateExitCode -eq 0) {
            Write-Host "‚úì Successfully submitted PR to microsoft/winget-pkgs" -ForegroundColor Green
          } else {
            Write-Host ""
            Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Yellow
            Write-Host "  FIRST-TIME WINGET SUBMISSION REQUIRED" -ForegroundColor Yellow
            Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "  The package 'DavideMaggi.KonciergeUI' doesn't exist yet in winget-pkgs." -ForegroundColor White
            Write-Host "  This is expected for the first release!" -ForegroundColor White
            Write-Host ""
            Write-Host "  To submit your package for the first time:" -ForegroundColor Cyan
            Write-Host "  1. Download the 'winget-manifest-${{ steps.gitversion.outputs.semver }}' artifact" -ForegroundColor Gray
            Write-Host "  2. Fork https://github.com/microsoft/winget-pkgs" -ForegroundColor Gray
            Write-Host "  3. Copy manifest files to: manifests/d/DavideMaggi/KonciergeUI/$version/" -ForegroundColor Gray
            Write-Host "  4. Submit a Pull Request to microsoft/winget-pkgs" -ForegroundColor Gray
            Write-Host ""
            Write-Host "  After your first PR is merged, automatic updates will work!" -ForegroundColor Green
            Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Yellow
            Write-Host ""
            # Don't fail the workflow for first-time submission
            exit 0
          }

      - name: Upload WinGet manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifest-${{ steps.gitversion.outputs.semver }}
          path: ${{ steps.winget.outputs.manifest_dir }}
          retention-days: 90

      - name: Build Chocolatey package
        id: choco
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          
          $version = "${{ steps.gitversion.outputs.majorminorpatch }}"
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "${{ github.event.repository.name }}"
          $zipUrl = "https://github.com/$repoOwner/$repoName/releases/download/v${{ steps.gitversion.outputs.majorminorpatch }}/KonciergeUi-win-${{ steps.gitversion.outputs.semver }}.zip"
          $checksum = "${{ steps.hash.outputs.sha256 }}"
          
          $chocoDir = Join-Path $env:GITHUB_WORKSPACE "chocolatey/konciergeui"
          $toolsDir = Join-Path $chocoDir "tools"
          
          # Update install script with URL and checksum
          $installScript = Join-Path $toolsDir "chocolateyinstall.ps1"
          $content = Get-Content $installScript -Raw
          $content = $content -replace '\$url64\$', $zipUrl
          $content = $content -replace '\$checksum64\$', $checksum
          Set-Content -Path $installScript -Value $content -NoNewline
          
          # Update nuspec with version
          $nuspecPath = Join-Path $chocoDir "konciergeui.nuspec"
          $content = Get-Content $nuspecPath -Raw
          $content = $content -replace '\$version\$', $version
          Set-Content -Path $nuspecPath -Value $content -NoNewline
          
          # Build the package
          Push-Location $chocoDir
          choco pack
          Pop-Location
          
          $nupkgPath = Join-Path $chocoDir "konciergeui.$version.nupkg"
          if (-not (Test-Path $nupkgPath)) {
            throw "Chocolatey package not found: $nupkgPath"
          }
          
          # Move to artifacts
          $artifactsDir = Join-Path $env:GITHUB_WORKSPACE "artifacts"
          Move-Item $nupkgPath $artifactsDir
          
          $finalPath = Join-Path $artifactsDir "konciergeui.$version.nupkg"
          "nupkg_path=$finalPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "‚úì Chocolatey package created: $finalPath" -ForegroundColor Green

      - name: Publish to Chocolatey
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && vars.CHOCOLATEY_AUTO_PUBLISH == 'true'
        shell: pwsh
        env:
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: |
          $ErrorActionPreference = 'Continue'
          
          if ([string]::IsNullOrEmpty($env:CHOCOLATEY_API_KEY)) {
            Write-Host "CHOCOLATEY_API_KEY not configured - skipping Chocolatey publish" -ForegroundColor Yellow
            Write-Host "To enable automatic publishing:" -ForegroundColor Yellow
            Write-Host "  1. Get your API key from https://community.chocolatey.org/account" -ForegroundColor Gray
            Write-Host "  2. Add it as a repository secret named 'CHOCOLATEY_API_KEY'" -ForegroundColor Gray
            Write-Host "  3. Create a repository variable 'CHOCOLATEY_AUTO_PUBLISH' with value 'true'" -ForegroundColor Gray
            exit 0
          }
          
          $nupkgPath = "${{ steps.choco.outputs.nupkg_path }}"
          
          Write-Host "Publishing to Chocolatey Community Repository..." -ForegroundColor Cyan
          choco push $nupkgPath --source https://push.chocolatey.org/ --api-key $env:CHOCOLATEY_API_KEY
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úì Successfully published to Chocolatey!" -ForegroundColor Green
          } else {
            Write-Host "Failed to publish to Chocolatey. The package may need manual review." -ForegroundColor Yellow
            exit 0
          }

      - name: Upload Chocolatey package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-konciergeui-${{ steps.gitversion.outputs.semver }}
          path: ${{ steps.choco.outputs.nupkg_path }}
          retention-days: 90

